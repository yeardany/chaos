const path=require('path'),HTMLPlugin=require('html-webpack-plugin'),webpack=require('webpack'),merge=require('webpack-merge'),ExtractPlugin=require('extract-text-webpack-plugin'),UglifyJsPlugin=require('uglifyjs-webpack-plugin'),api=require('../config/api'),isDev=process.env.NODE_ENV==='development',defaultPluins=[new webpack.DefinePlugin({'process.env':{NODE_ENV:isDev?'"development"':'"production"'}}),new UglifyJsPlugin({parallel:true,uglifyOptions:{output:{comments:false,beautify:false},compress:{warnings:false,dead_code:true,conditionals:true,booleans:true,if_return:true,drop_console:true},},cache:true})],devServer={port:8000,host:'0.0.0.0',overlay:{errors:true},hot:true,proxy:{'/api':{target:api.apiAddress,changeOrigin:true,pathRewrite:{'^/api':''}}}},baseConfig={target:'web',entry:path.join(__dirname,'../index.js'),output:{filename:'bundle.[hash:8].js',path:path.join(__dirname,'./www')},module:{rules:[{test:/\.(vue|js|jsx)$/,loader:'eslint-loader',exclude:/node_modules/,enforce:'pre'},{test:/\.vue$/,loader:'vue-loader',options:{preserveWhitepace:true,extractCSS:!isDev,cssModules:{localIdentName:isDev?'[path]-[name]-[hash:base64:5]':'[hash:base64:5]',camelCase:true},}},{test:/\.jsx$/,loader:'babel-loader'},{test:/\.js$/,loader:'babel-loader',exclude:/node_modules/},{test:/\.(gif|jpg|jpeg|png|svg|ttf|eot|woff)$/,use:[{loader:'url-loader',options:{limit:1024,name:'resources/[path][name].[hash:8].[ext]'}}]}]}},template=`<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible"content="IE=edge"><meta http-equiv="Content-Security-Policy"content="default-src https://codepush.azurewebsites.net 'self' data: gap: cdvfile: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline' https: http: wss: ws:; img-src * filesystem: cdvfile: data:; media-src * blob:; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'"/><meta name="format-detection"content="telephone=no"><meta name="msapplication-tap-highlight"content="no"><meta name="viewport"content="user-scalable=no width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover"><meta name="apple-mobile-web-app-capable"content="yes"><meta name="apple-mobile-web-app-status-bar-style"content="black"><title>APP</title><style>*{touch-action:pan-y;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-ms-touch-action:manipulation;-webkit-overflow-scrolling:touch}input{-webkit-user-select:auto}</style></head><body><div id="root"></div><script type="text/javascript"src="cordova.js"></script></body></html>`
let config;if(isDev){config=merge(baseConfig,{devtool:'#cheap-module-eval-source-map',module:{rules:[{test:/\.css/,use:['vue-style-loader','css-loader',{loader:'postcss-loader',options:{sourceMap:true}}]}]},devServer,plugins:defaultPluins.concat([new webpack.HotModuleReplacementPlugin(),new webpack.NoEmitOnErrorsPlugin(),new HTMLPlugin({templateContent:template})])})}else{config=merge(baseConfig,{entry:{app:path.join(__dirname,'../index-build.js'),vendor:['vue']},output:{filename:'[name].js'},module:{rules:[{test:/\.css/,use:ExtractPlugin.extract({fallback:'vue-style-loader',use:['css-loader',{loader:'postcss-loader',options:{sourceMap:true,}}]})}]},plugins:defaultPluins.concat([new ExtractPlugin('styles.css'),new webpack.optimize.CommonsChunkPlugin({name:'vendor'}),new webpack.optimize.CommonsChunkPlugin({name:'runtime'}),new HTMLPlugin({templateContent:template})])})};module.exports=config
